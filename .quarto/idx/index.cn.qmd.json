{"title":"SQL handbook","markdown":{"yaml":{"title":"SQL handbook","author":"Tony Duan","execute":{"warning":false,"error":false},"format":{"html":{"toc":true,"toc-location":"right","code-fold":"show","code-tools":true,"number-sections":true,"code-block-bg":true,"code-block-border-left":"#31BAE9"}}},"headingText":"介绍数据分析工具","containsRefs":false,"markdown":"\n\n\n本文档提供了使用 SQL、R 和 Python 执行常见数据操作任务的综合指南。它可作为理解如何在这三种流行的数据分析工具中实现相似结果的参考。\n\n\n在数据分析中，我们使用不同的工具，每个工具都有其优势：\n\n- **SQL**：擅长结构化查询和数据库操作\n- **R**：强大的统计计算和数据可视化\n- **Python**：多功能编程，拥有优秀的数据科学库\n\n本教程展示了如何在所有三个工具中完成相同的数据操作任务，帮助您为您的需求选择正确的方法。\n\n\n# 设置与配置\n\n```{r}\n#| code-fold: true\n#| output: false\nlibrary(reticulate)\npy_require(c(\"pandas\",\"Great-Tables\",\"polars\",\"pyarrow\"))\n\n# Load libraries for database interaction, data manipulation, and connections.\nlibrary(DBI)\nlibrary(tidyverse)\nlibrary(RSQLite)\nlibrary(connections)\nlibrary(duckdb)\n\n# Prepare the R dataframes.\n# Remove the existing mtcars dataset if it exists.\nrm(mtcars)\n# Create the mtcars dataframe from the base R dataset, adding the row names as a new column.\nmtcars = cbind(model_name = rownames(mtcars), mtcars) |> head(10)\n# Create the iris dataframe from the base R dataset.\niris = iris |> head(10)\n\n# Remove the database file if it already exists to start with a clean slate.\nif (file.exists(\"my-db.duckdb\")) {\n  file.remove(\"my-db.duckdb\")\n}\n# Establish a connection to the DuckDB database.\ncon <- dbConnect(duckdb(), dbdir = \"my-db.duckdb\", read_only = FALSE)\n# Write the iris and mtcars dataframes to the database as tables.\ndbWriteTable(con, \"iris_table\", iris, overwrite = TRUE)\ndbWriteTable(con, \"mtcars_table\", mtcars, overwrite = TRUE)\n\n```\n\n\n```{python}\n#| code-fold: true\n#| output: false\nimport pandas as pd\nimport polars as pl\nimport os\n\nfrom platform import python_version\n#print(python_version())\n\ncities_pd = pd.DataFrame({\n    'country': ['NL', 'NL', 'NL', 'US', 'US', 'US', 'US', 'US', 'US'],\n    'name': ['Amsterdam', 'Amsterdam', 'Amsterdam', 'Seattle', 'Seattle', 'Seattle', 'New York City', 'New York City', 'New York City'],\n    'year': [2000, 2010, 2020, 2000, 2010, 2020, 2000, 2010, 2020],\n    'population': [1005, 1065, 1158, 564, 608, 738, 8015, 8175, 8772]\n})\n\n# Make the R dataframes available in the Python environment.\nmtcars_pd = r.mtcars\niris_pd = r.iris\nmtcars_pl = pl.from_pandas(mtcars_pd)\niris_pl = pl.from_pandas(iris_pd)\ncities_pl=pl.from_pandas(cities_pd)\n```\n\n\n- DuckDB 数据库 `my-db.duckdb` 中有 `iris_table` 和 `mtcars_table` 表。\n- R 环境中有 `iris` 和 `mtcars` 数据框。\n- Python 环境中有 `iris` 和 `mtcars` 数据框。\n\n# 显示所有表\n\n本节演示如何列出每个环境中的所有可用表或数据框。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 显示所连接数据库中的所有表。\nSHOW ALL TABLES;\n```\n\n## R\n\n```{r}\n# 列出当前 R 环境中的所有数据框。\ndflist <- Filter(is.data.frame, as.list(.GlobalEnv))\nnames(dflist)\n```\n\n## Python pandas\n\n```{python}\n# 列出当前 Python 环境中的所有 pandas 数据框。\nimport pandas as pd\nalldfs = [var for var in dir() if isinstance(eval(var), pd.core.frame.DataFrame)]\nprint(alldfs)\n```\n\n## Python Polars\n\n```{python}\nimport polars as pl\n\nalldfs = [name for name, val in globals().items() if isinstance(val, pl.DataFrame)]\nprint(alldfs)\n```\n\n\n:::\n\n# 描述表\n\n本节介绍如何获取表结构和统计信息的摘要。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 描述 mtcars_table 的列和数据类型。\nDESCRIBE mtcars_table;\n```\n\n## R\n\n```{r}\n# 提供 mtcars 数据框的详细摘要。\nskimr::skim(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# 生成 mtcars 数据框的描述性统计信息。\nmtcars_pd.describe(include='all')\n```\n\n\n\n## Python Polars\n\n```{python}\nmtcars_pl.describe()\n```\n\n\n\n\n:::\n\n# 显示列名\n\n本节演示如何检索表的列名。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 显示 mtcars_table 中列的信息。\nPRAGMA table_info(mtcars_table);\n```\n\n## R\n\n```{r}\n# 获取 mtcars 数据框的列名。\nnames(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# 从 mtcars 数据框获取列名列表。\nimport pandas as pd\nlist(mtcars_pd.columns.values)\n```\n\n\n## Python Polars\n\n```{python}\n# 从 mtcars 数据框获取列名列表。\nmtcars_pl.columns\n```\n\n\n\n:::\n\n# 选择\n\n## 选择前 6 行并重命名\n\n本节介绍如何选择列的子集、重命名它们并限制返回的行数。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 选择并重命名列，将结果限制为前 6 行。\nSELECT model_name as model, mpg, cyl FROM mtcars_table LIMIT 6;\n```\n\n## R\n\n```{r}\n# 从 mtcars 数据框的前 6 行中选择并重命名列。\nhead(mtcars, 6) |> select(model = model_name, mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# 重命名 mtcars 数据框中的列。\nmtcars_pd.rename(columns={'model_name': 'model'})\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"model_name\").alias(\"model\"), pl.col(\"mpg\"), pl.col(\"cyl\")).head(6)\n```\n\n:::\n\n## 选择不同行\n\n本节演示如何根据指定的列检索唯一的行。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 选择 mpg 和 cyl 的不同组合。\nSELECT DISTINCT mpg, cyl FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# 根据 mpg 和 cyl 获取不同的行。\nmtcars |> distinct(mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# 选择特定列并删除重复行。\ndf = mtcars_pd[[\"mpg\", \"cyl\"]]\nprint(df.drop_duplicates())\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"mpg\"), pl.col(\"cyl\")).unique()\n```\n\n:::\n\n# 检查行数和列数\n\n本节介绍如何查找表的维度。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 获取总行数。\nSELECT count(*) AS row_number FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 获取总列数。\nSELECT count(*) AS column_number FROM (DESCRIBE mtcars_table);\n```\n\n## R\n\n```{r}\n# 获取行数。\nnrow(mtcars)\n```\n\n```{r}\n# 获取列数。\nncol(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# 获取行数。\nmtcars_pd.shape[0]\n```\n\n```{python}\n# 获取列数。\nmtcars_pd.shape[1]\n```\n\n\n\n## Python Polars\n\n```{python}\n# 获取行数。\nmtcars_pl.shape[0]\n```\n\n```{python}\n# 获取列数。\nmtcars_pl.shape[1]\n```\n\n\n\n:::\n\n# 创建列\n\n本节演示如何基于现有数据向表中添加新列。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 通过对现有列执行计算来创建新列。\nSELECT *, mpg + 1 AS new_mpg FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# 向数据框添加新列。\nmtcars |> mutate(new_mpg = mpg + 1)\n```\n\n## Python pandas\n\n```{python}\n# 在数据框中创建新列。\nmtcars_pd[\"new_mpg\"] = mtcars_pd[\"mpg\"] + 1\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns((pl.col(\"mpg\") + 1).alias(\"new_mpg\"))\n```\n\n:::\n\n# 筛选\n\n本节介绍如何选择满足特定条件的行。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 使用 AND 运算符根据多个条件筛选行。\nSELECT * FROM mtcars_table WHERE mpg = 21 AND cyl = 6;\n```\n\n```{sql}\n#| connection: con\n-- 使用 OR 运算符筛选行。\nSELECT * FROM mtcars_table WHERE mpg = 21 OR cyl = 6;\n```\n\n## R\n\n```{r}\n# 使用 & 运算符进行“与”筛选。\nmtcars |> filter(mpg == 21 & cyl == 6)\n```\n\n```{r}\n# 使用 | 运算符进行“或”筛选。\nmtcars |> filter(mpg == 21 | cyl == 6)\n```\n\n## Python pandas\n\n```{python}\n# 使用 query 方法进行“与”筛选。\nmtcars_pd.query('mpg == 21 and cyl == 6')\n```\n\n```{python}\n# 使用 query 方法进行“或”筛选。\nmtcars_pd.query('mpg == 21 or cyl == 6')\n```\n\n## Python Polars\n\n```{python}\n# polars 的“与”筛选\nmtcars_pl.filter((pl.col(\"mpg\") == 21) & (pl.col(\"cyl\") == 6))\n```\n\n```{python}\n# polars 的“或”筛选\nmtcars_pl.filter((pl.col(\"mpg\") == 21) | (pl.col(\"cyl\") == 6))\n```\n\n:::\n\n# 排序\n\n本节演示如何根据一个或多个列对表进行排序。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 按 mpg 降序对结果进行排序，并显示前 3 行。\nSELECT model_name AS model, mpg, cyl FROM mtcars_table ORDER BY mpg DESC LIMIT 3;\n```\n\n## R\n\n```{r}\n# 按 mpg 降序排列数据框。\nmtcars |> select(model = model_name, mpg, cyl) |> arrange(desc(mpg)) |> head(3)\n```\n\n## Python pandas\n\n```{python}\n# 按 mpg 降序对数据框进行排序。\nmtcars_pd[[\"model_name\", \"mpg\", \"cyl\"]].sort_values(by='mpg', ascending=False).head(3)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(\"model_name\", \"mpg\", \"cyl\").sort(\"mpg\", descending=True).head(3)\n```\n\n:::\n\n# 分组\n\n本节介绍如何对行进行分组并执行聚合计算。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 按 model_name 分组，并计算 mpg 的总和和 cyl 的平均值。\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1 LIMIT 5;\n```\n\n## R\n\n```{r}\n# 按 model_name 分组并汇总数据。\nmtcars |> group_by(model_name) |> summarise(total_mpg = sum(mpg), cyl_mean = mean(cyl)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# 按 model_name 分组并聚合数据。\nmtcars_pd.groupby('model_name').agg({'mpg': 'sum', 'cyl': 'mean'}).head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.group_by(\"model_name\").agg([\n    pl.sum(\"mpg\").alias(\"total_mpg\"),\n    pl.mean(\"cyl\").alias(\"cyl_mean\")\n]).head(5)\n```\n\n:::\n\n# 创建表\n\n## CREATE OR REPLACE\n\n此命令创建新表或覆盖现有表。\n\n```{sql}\n#| connection: con\n-- 创建一个临时表，如果它已存在则替换它。\nCREATE OR REPLACE TEMP TABLE mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n## CREATE TABLE IF NOT EXISTS\n\n此命令仅在表尚不存在时创建表。\n\n```{sql}\n#| connection: con\n-- 仅在尚不存在的情况下创建新表。\nCREATE TABLE IF NOT EXISTS new_mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n# 唯一值\n\n## 检查唯一值\n\n本节演示如何验证列中值的唯一性。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 计算总行数和不同 model_name 的数量。\nSELECT count(*), count(DISTINCT model_name) FROM mtcars_table;\n```\n\n### Python pandas\n\n```{python}\n# 计算总行数和不同 model_name 的数量。\nprint(len(mtcars_pd), mtcars_pd.model_name.nunique())\n```\n\n### Python Polars\n\n```{python}\n# 计算总行数和不同 model_name 的数量。\nmtcars_pl.select(pl.count(), pl.col(\"model_name\").n_unique())\n```\n\n:::\n\n## 获取重复和非重复数据\n\n本节演示如何根据单个列获取重复和非重复数据。\n\n::: panel-tabset\n\n### SQL\n\n#### 显示所有重复项\n\n```{sql}\n#| connection: con\n-- 根据 mpg 列获取重复行。\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) > 1);\n```\n\n#### 保留非重复项\n\n```{sql}\n#| connection: con\n-- 根据 mpg 列获取非重复行。\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) = 1);\n```\n\n### R\n\n#### 显示所有重复项\n\n\n```{r}\n# 根据 mpg 列获取重复行。\nmtcars |> filter(duplicated(mpg) | duplicated(mpg, fromLast = TRUE))\n```\n\n#### 保留非重复项\n\n\n```{r}\n# 根据 mpg 列获取非重复行。\nmtcars |> filter(!duplicated(mpg) & !duplicated(mpg, fromLast = TRUE))\n```\n\n### Python pandas\n\n#### 显示所有重复项\n\n\n```{python}\n# 根据 mpg 列获取重复行。\nmtcars_pd[mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n#### 保留非重复项\n\n```{python}\n# 根据 mpg 列获取非重复行。\nmtcars_pd[~mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n\n### Python Polars\n\n```{python}\n# 根据 mpg 列获取重复行。\nmtcars_pl.filter(pl.col(\"mpg\").is_duplicated())\n```\n\n#### 保留非重复项\n\n```{python}\n# 根据 mpg 列获取非重复行。\nmtcars_pl.filter(pl.col(\"mpg\").is_unique())\n```\n\n:::\n\n\n# 连接\n\n```{sql}\n#| connection: con\n-- 从新创建的临时表中选择所有数据。\nSELECT * FROM mtcars_table_group t1;\n```\n\n## 左连接\n\n本节介绍如何执行左连接以组合来自两个表的数据。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 在 mtcars_table 和 mtcars_table_group 之间执行左连接。\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nLEFT JOIN mtcars_table_group t2 ON t1.model_name = t2.model_name\nLIMIT 5;\n```\n\n## R\n\n```{r}\n# 对 mtcars 数据框与其自身执行左连接。\nmtcars |> left_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# 使用 pandas 执行左连接。\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='left').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"left\").head(5)\n```\n\n:::\n\n## 内连接\n\n本节演示如何执行内连接。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 使用子查询执行内连接。\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table_group LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n## R\n\n```{r}\n# 执行内连接。\nmtcars |> inner_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# 使用 pandas 执行内连接。\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='inner').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"inner\").head(5)\n```\n\n:::\n\n# 追加行\n\n## 追加时不消除重复项 (`union all`)\n\n本节介绍如何组合来自两个表的行，并保留所有重复项。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 计算原始表中的行数。\nSELECT count(*) FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 通过将 mtcars_table 追加到自身（包括重复项）来创建新表。\nCREATE TEMP TABLE double_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION ALL\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 计算新表中的行数。\nSELECT count(*) FROM double_mtcars_table;\n```\n\n### R\n\n```{r}\n# 使用 bind_rows 追加行。\nmtcars %>% bind_rows(mtcars)\n```\n\n### Python pandas\n\n```{python}\n# 连接数据框，保留所有行。\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True)\n```\n\n:::\n\n## 追加时消除重复项 (`union`)\n\n本节演示如何在组合行时删除重复条目。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 创建一个表，删除重复行。\nCREATE OR REPLACE TEMP TABLE double_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 计算新表中的行数。\nSELECT count(*) FROM double_mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 验证不同行的计数。\nSELECT count(*) FROM (\n  SELECT DISTINCT * FROM double_mtcars_table\n);\n```\n\n### R\n\n```{r}\n# 追加行然后删除重复项。\nmtcars %>% bind_rows(mtcars) |> distinct()\n```\n\n### Python pandas\n\n```{python}\n# 连接数据框然后删除重复项。\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True).drop_duplicates()\n```\n\n:::\n\n# 删除行\n\n本节介绍如何根据条件从表中删除行。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 从表中删除特定行。\nDELETE FROM mtcars_table WHERE model_name = 'Mazda RX4';\n```\n\n```{sql}\n#| connection: con\n-- 验证删除后的行数。\nSELECT count(*) FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# 筛选掉指定的行。\nmtcars |> filter(model_name != 'Mazda RX4')\n```\n\n## Python pandas\n\n```{python}\n# 选择除指定行之外的所有行。\nmtcars_pd[mtcars_pd['model_name'] != 'Mazda RX4']\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.filter(pl.col(\"model_name\") != 'Mazda RX4')\n```\n\n:::\n\n# 更新行\n\n本节演示如何修改表中的现有数据。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 选择要更新的行。\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- 更新特定行的列值。\nUPDATE mtcars_table\nSET mpg = 999\nWHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- 验证更新。\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n## R\n\n```{r}\n# 在筛选的选择中更新值。\nmtcars |> filter(model_name == 'Mazda RX4 Wag') |> mutate(mpg = 999)\n```\n\n## Python pandas\n\n```{python}\n# 使用 .loc 更新特定值。\nmtcars_pd.loc[mtcars_pd['model_name'] == 'Mazda RX4 Wag', 'mpg'] = 999\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns(\n    pl.when(pl.col(\"model_name\") == 'Mazda RX4 Wag')\n    .then(999)\n    .otherwise(pl.col(\"mpg\"))\n    .alias(\"mpg\")\n)\n```\n\n:::\n\n# 删除表\n\n本节介绍如何从数据库中删除表。\n\n删除表之前：\n\n```{sql}\n#| connection: con\n-- 在删除一个表之前显示所有表。\nSHOW ALL TABLES;\n```\n\n删除表：\n\n```{sql}\n#| connection: con\n-- 如果存在，则删除指定的表。\nDROP TABLE IF EXISTS mtcars_table_group;\n```\n\n删除表之后：\n\n```{sql}\n#| connection: con\n-- 再次显示所有表以确认删除。\nSHOW ALL TABLES;\n```\n\n# PIVOT (透视)\n\n本节演示如何将数据从长格式转换为宽格式。\n\n```{sql}\n#| connection: con\n-- 为透视演示创建一个临时表。\nDROP TABLE IF EXISTS cities;\nCREATE TEMP TABLE cities (\n    country VARCHAR, name VARCHAR, year INTEGER, population INTEGER\n);\nINSERT INTO cities VALUES\n    ('NL', 'Amsterdam', 2000, 1005),\n    ('NL', 'Amsterdam', 2010, 1065),\n    ('NL', 'Amsterdam', 2020, 1158),\n    ('US', 'Seattle', 2000, 564),\n    ('US', 'Seattle', 2010, 608),\n    ('US', 'Seattle', 2020, 738),\n    ('US', 'New York City', 2000, 8015),\n    ('US', 'New York City', 2010, 8175),\n    ('US', 'New York City', 2020, 8772);\n```\n\n```{sql}\n#| connection: con\n-- 查看原始数据。\nSELECT * FROM cities;\n```\n\n## 对一列进行透视\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 对 'year' 列进行透视。\nPIVOT cities\nON year\nUSING sum(population)\nGROUP BY country;\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n## 对两列进行透视\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 对 'country' 和 'name' 进行透视。\nPIVOT cities\nON country, name\nUSING sum(population);\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index=['country', 'name'], columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index=['country', 'name'], columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n# UNPIVOT (逆透视)\n\n本节介绍如何将数据从宽格式转换为长格式。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 对先前透视的表进行逆透视。\nUNPIVOT\n(\n  PIVOT cities\n  ON year\n  USING sum(population)\n  GROUP BY country\n)\nON COLUMNS(* EXCLUDE (country))\nINTO\n    NAME year\n    VALUE population;\n```\n\n### Python pandas\n\n\n\n\n```{python}\ncities_pivot_pd = cities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\ncities_pivot_pd.melt(id_vars='country', value_vars=[2000, 2010, 2020], var_name='year', value_name='population')\n```\n\n### Python Polars\n\n```{python}\ncities_pl = pl.from_pandas(cities_pd)\n```\n\n\n```{python}\ncities_pivot_pl = cities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\ncities_pivot_pl.unpivot(index='country', on=['2000', '2010', '2020'], variable_name='year', value_name='population')\n```\n\n:::\n\n# EXPLAIN (解释)\n\n本节演示如何分析查询的执行计划。\n\n```{sql}\n#| eval: false\n#| connection: con\n-- 显示查询的逻辑执行计划。\nEXPLAIN\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n```{sql}\n#| eval: false\n#| connection: con\n-- 显示详细的执行计划，包括计时信息。\nEXPLAIN ANALYZE\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n```{r}\n# 断开与数据库的连接并关闭它。\ndbDisconnect(con, shutdown = TRUE)\n```\n\n# 显示精美的表格\n\n本节介绍如何创建格式精美的表格以供演示。\n\n::: panel-tabset\n\n## R\n\n```{r}\n# 使用 gt 库创建格式化的表格。\nlibrary(gt)\nmtcars |> gt()\n```\n\n## Python pandas\n\n```{python}\n# 使用 great_tables 库创建格式化的表格。\nfrom great_tables import GT\nGT(mtcars_pd)\n```\n\n## Python Polars\n\n```{python}\n# 使用 great_tables 库创建格式化的表格。\nfrom great_tables import GT\nGT(mtcars_pl)\n```\n\n\n\n\n:::\n\n# 参考资料:\n\n- [DuckDB R 客户端文档](https://duckdb.org/docs/stable/clients/r.html)\n- [DuckDB SQL 语句](https://duckdb.org/docs/stable/sql/statements)\n","srcMarkdownNoYaml":"\n\n\n本文档提供了使用 SQL、R 和 Python 执行常见数据操作任务的综合指南。它可作为理解如何在这三种流行的数据分析工具中实现相似结果的参考。\n\n## 介绍数据分析工具\n\n在数据分析中，我们使用不同的工具，每个工具都有其优势：\n\n- **SQL**：擅长结构化查询和数据库操作\n- **R**：强大的统计计算和数据可视化\n- **Python**：多功能编程，拥有优秀的数据科学库\n\n本教程展示了如何在所有三个工具中完成相同的数据操作任务，帮助您为您的需求选择正确的方法。\n\n\n# 设置与配置\n\n```{r}\n#| code-fold: true\n#| output: false\nlibrary(reticulate)\npy_require(c(\"pandas\",\"Great-Tables\",\"polars\",\"pyarrow\"))\n\n# Load libraries for database interaction, data manipulation, and connections.\nlibrary(DBI)\nlibrary(tidyverse)\nlibrary(RSQLite)\nlibrary(connections)\nlibrary(duckdb)\n\n# Prepare the R dataframes.\n# Remove the existing mtcars dataset if it exists.\nrm(mtcars)\n# Create the mtcars dataframe from the base R dataset, adding the row names as a new column.\nmtcars = cbind(model_name = rownames(mtcars), mtcars) |> head(10)\n# Create the iris dataframe from the base R dataset.\niris = iris |> head(10)\n\n# Remove the database file if it already exists to start with a clean slate.\nif (file.exists(\"my-db.duckdb\")) {\n  file.remove(\"my-db.duckdb\")\n}\n# Establish a connection to the DuckDB database.\ncon <- dbConnect(duckdb(), dbdir = \"my-db.duckdb\", read_only = FALSE)\n# Write the iris and mtcars dataframes to the database as tables.\ndbWriteTable(con, \"iris_table\", iris, overwrite = TRUE)\ndbWriteTable(con, \"mtcars_table\", mtcars, overwrite = TRUE)\n\n```\n\n\n```{python}\n#| code-fold: true\n#| output: false\nimport pandas as pd\nimport polars as pl\nimport os\n\nfrom platform import python_version\n#print(python_version())\n\ncities_pd = pd.DataFrame({\n    'country': ['NL', 'NL', 'NL', 'US', 'US', 'US', 'US', 'US', 'US'],\n    'name': ['Amsterdam', 'Amsterdam', 'Amsterdam', 'Seattle', 'Seattle', 'Seattle', 'New York City', 'New York City', 'New York City'],\n    'year': [2000, 2010, 2020, 2000, 2010, 2020, 2000, 2010, 2020],\n    'population': [1005, 1065, 1158, 564, 608, 738, 8015, 8175, 8772]\n})\n\n# Make the R dataframes available in the Python environment.\nmtcars_pd = r.mtcars\niris_pd = r.iris\nmtcars_pl = pl.from_pandas(mtcars_pd)\niris_pl = pl.from_pandas(iris_pd)\ncities_pl=pl.from_pandas(cities_pd)\n```\n\n\n- DuckDB 数据库 `my-db.duckdb` 中有 `iris_table` 和 `mtcars_table` 表。\n- R 环境中有 `iris` 和 `mtcars` 数据框。\n- Python 环境中有 `iris` 和 `mtcars` 数据框。\n\n# 显示所有表\n\n本节演示如何列出每个环境中的所有可用表或数据框。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 显示所连接数据库中的所有表。\nSHOW ALL TABLES;\n```\n\n## R\n\n```{r}\n# 列出当前 R 环境中的所有数据框。\ndflist <- Filter(is.data.frame, as.list(.GlobalEnv))\nnames(dflist)\n```\n\n## Python pandas\n\n```{python}\n# 列出当前 Python 环境中的所有 pandas 数据框。\nimport pandas as pd\nalldfs = [var for var in dir() if isinstance(eval(var), pd.core.frame.DataFrame)]\nprint(alldfs)\n```\n\n## Python Polars\n\n```{python}\nimport polars as pl\n\nalldfs = [name for name, val in globals().items() if isinstance(val, pl.DataFrame)]\nprint(alldfs)\n```\n\n\n:::\n\n# 描述表\n\n本节介绍如何获取表结构和统计信息的摘要。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 描述 mtcars_table 的列和数据类型。\nDESCRIBE mtcars_table;\n```\n\n## R\n\n```{r}\n# 提供 mtcars 数据框的详细摘要。\nskimr::skim(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# 生成 mtcars 数据框的描述性统计信息。\nmtcars_pd.describe(include='all')\n```\n\n\n\n## Python Polars\n\n```{python}\nmtcars_pl.describe()\n```\n\n\n\n\n:::\n\n# 显示列名\n\n本节演示如何检索表的列名。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 显示 mtcars_table 中列的信息。\nPRAGMA table_info(mtcars_table);\n```\n\n## R\n\n```{r}\n# 获取 mtcars 数据框的列名。\nnames(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# 从 mtcars 数据框获取列名列表。\nimport pandas as pd\nlist(mtcars_pd.columns.values)\n```\n\n\n## Python Polars\n\n```{python}\n# 从 mtcars 数据框获取列名列表。\nmtcars_pl.columns\n```\n\n\n\n:::\n\n# 选择\n\n## 选择前 6 行并重命名\n\n本节介绍如何选择列的子集、重命名它们并限制返回的行数。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 选择并重命名列，将结果限制为前 6 行。\nSELECT model_name as model, mpg, cyl FROM mtcars_table LIMIT 6;\n```\n\n## R\n\n```{r}\n# 从 mtcars 数据框的前 6 行中选择并重命名列。\nhead(mtcars, 6) |> select(model = model_name, mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# 重命名 mtcars 数据框中的列。\nmtcars_pd.rename(columns={'model_name': 'model'})\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"model_name\").alias(\"model\"), pl.col(\"mpg\"), pl.col(\"cyl\")).head(6)\n```\n\n:::\n\n## 选择不同行\n\n本节演示如何根据指定的列检索唯一的行。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 选择 mpg 和 cyl 的不同组合。\nSELECT DISTINCT mpg, cyl FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# 根据 mpg 和 cyl 获取不同的行。\nmtcars |> distinct(mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# 选择特定列并删除重复行。\ndf = mtcars_pd[[\"mpg\", \"cyl\"]]\nprint(df.drop_duplicates())\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"mpg\"), pl.col(\"cyl\")).unique()\n```\n\n:::\n\n# 检查行数和列数\n\n本节介绍如何查找表的维度。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 获取总行数。\nSELECT count(*) AS row_number FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 获取总列数。\nSELECT count(*) AS column_number FROM (DESCRIBE mtcars_table);\n```\n\n## R\n\n```{r}\n# 获取行数。\nnrow(mtcars)\n```\n\n```{r}\n# 获取列数。\nncol(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# 获取行数。\nmtcars_pd.shape[0]\n```\n\n```{python}\n# 获取列数。\nmtcars_pd.shape[1]\n```\n\n\n\n## Python Polars\n\n```{python}\n# 获取行数。\nmtcars_pl.shape[0]\n```\n\n```{python}\n# 获取列数。\nmtcars_pl.shape[1]\n```\n\n\n\n:::\n\n# 创建列\n\n本节演示如何基于现有数据向表中添加新列。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 通过对现有列执行计算来创建新列。\nSELECT *, mpg + 1 AS new_mpg FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# 向数据框添加新列。\nmtcars |> mutate(new_mpg = mpg + 1)\n```\n\n## Python pandas\n\n```{python}\n# 在数据框中创建新列。\nmtcars_pd[\"new_mpg\"] = mtcars_pd[\"mpg\"] + 1\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns((pl.col(\"mpg\") + 1).alias(\"new_mpg\"))\n```\n\n:::\n\n# 筛选\n\n本节介绍如何选择满足特定条件的行。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 使用 AND 运算符根据多个条件筛选行。\nSELECT * FROM mtcars_table WHERE mpg = 21 AND cyl = 6;\n```\n\n```{sql}\n#| connection: con\n-- 使用 OR 运算符筛选行。\nSELECT * FROM mtcars_table WHERE mpg = 21 OR cyl = 6;\n```\n\n## R\n\n```{r}\n# 使用 & 运算符进行“与”筛选。\nmtcars |> filter(mpg == 21 & cyl == 6)\n```\n\n```{r}\n# 使用 | 运算符进行“或”筛选。\nmtcars |> filter(mpg == 21 | cyl == 6)\n```\n\n## Python pandas\n\n```{python}\n# 使用 query 方法进行“与”筛选。\nmtcars_pd.query('mpg == 21 and cyl == 6')\n```\n\n```{python}\n# 使用 query 方法进行“或”筛选。\nmtcars_pd.query('mpg == 21 or cyl == 6')\n```\n\n## Python Polars\n\n```{python}\n# polars 的“与”筛选\nmtcars_pl.filter((pl.col(\"mpg\") == 21) & (pl.col(\"cyl\") == 6))\n```\n\n```{python}\n# polars 的“或”筛选\nmtcars_pl.filter((pl.col(\"mpg\") == 21) | (pl.col(\"cyl\") == 6))\n```\n\n:::\n\n# 排序\n\n本节演示如何根据一个或多个列对表进行排序。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 按 mpg 降序对结果进行排序，并显示前 3 行。\nSELECT model_name AS model, mpg, cyl FROM mtcars_table ORDER BY mpg DESC LIMIT 3;\n```\n\n## R\n\n```{r}\n# 按 mpg 降序排列数据框。\nmtcars |> select(model = model_name, mpg, cyl) |> arrange(desc(mpg)) |> head(3)\n```\n\n## Python pandas\n\n```{python}\n# 按 mpg 降序对数据框进行排序。\nmtcars_pd[[\"model_name\", \"mpg\", \"cyl\"]].sort_values(by='mpg', ascending=False).head(3)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(\"model_name\", \"mpg\", \"cyl\").sort(\"mpg\", descending=True).head(3)\n```\n\n:::\n\n# 分组\n\n本节介绍如何对行进行分组并执行聚合计算。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 按 model_name 分组，并计算 mpg 的总和和 cyl 的平均值。\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1 LIMIT 5;\n```\n\n## R\n\n```{r}\n# 按 model_name 分组并汇总数据。\nmtcars |> group_by(model_name) |> summarise(total_mpg = sum(mpg), cyl_mean = mean(cyl)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# 按 model_name 分组并聚合数据。\nmtcars_pd.groupby('model_name').agg({'mpg': 'sum', 'cyl': 'mean'}).head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.group_by(\"model_name\").agg([\n    pl.sum(\"mpg\").alias(\"total_mpg\"),\n    pl.mean(\"cyl\").alias(\"cyl_mean\")\n]).head(5)\n```\n\n:::\n\n# 创建表\n\n## CREATE OR REPLACE\n\n此命令创建新表或覆盖现有表。\n\n```{sql}\n#| connection: con\n-- 创建一个临时表，如果它已存在则替换它。\nCREATE OR REPLACE TEMP TABLE mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n## CREATE TABLE IF NOT EXISTS\n\n此命令仅在表尚不存在时创建表。\n\n```{sql}\n#| connection: con\n-- 仅在尚不存在的情况下创建新表。\nCREATE TABLE IF NOT EXISTS new_mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n# 唯一值\n\n## 检查唯一值\n\n本节演示如何验证列中值的唯一性。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 计算总行数和不同 model_name 的数量。\nSELECT count(*), count(DISTINCT model_name) FROM mtcars_table;\n```\n\n### Python pandas\n\n```{python}\n# 计算总行数和不同 model_name 的数量。\nprint(len(mtcars_pd), mtcars_pd.model_name.nunique())\n```\n\n### Python Polars\n\n```{python}\n# 计算总行数和不同 model_name 的数量。\nmtcars_pl.select(pl.count(), pl.col(\"model_name\").n_unique())\n```\n\n:::\n\n## 获取重复和非重复数据\n\n本节演示如何根据单个列获取重复和非重复数据。\n\n::: panel-tabset\n\n### SQL\n\n#### 显示所有重复项\n\n```{sql}\n#| connection: con\n-- 根据 mpg 列获取重复行。\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) > 1);\n```\n\n#### 保留非重复项\n\n```{sql}\n#| connection: con\n-- 根据 mpg 列获取非重复行。\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) = 1);\n```\n\n### R\n\n#### 显示所有重复项\n\n\n```{r}\n# 根据 mpg 列获取重复行。\nmtcars |> filter(duplicated(mpg) | duplicated(mpg, fromLast = TRUE))\n```\n\n#### 保留非重复项\n\n\n```{r}\n# 根据 mpg 列获取非重复行。\nmtcars |> filter(!duplicated(mpg) & !duplicated(mpg, fromLast = TRUE))\n```\n\n### Python pandas\n\n#### 显示所有重复项\n\n\n```{python}\n# 根据 mpg 列获取重复行。\nmtcars_pd[mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n#### 保留非重复项\n\n```{python}\n# 根据 mpg 列获取非重复行。\nmtcars_pd[~mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n\n### Python Polars\n\n```{python}\n# 根据 mpg 列获取重复行。\nmtcars_pl.filter(pl.col(\"mpg\").is_duplicated())\n```\n\n#### 保留非重复项\n\n```{python}\n# 根据 mpg 列获取非重复行。\nmtcars_pl.filter(pl.col(\"mpg\").is_unique())\n```\n\n:::\n\n\n# 连接\n\n```{sql}\n#| connection: con\n-- 从新创建的临时表中选择所有数据。\nSELECT * FROM mtcars_table_group t1;\n```\n\n## 左连接\n\n本节介绍如何执行左连接以组合来自两个表的数据。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 在 mtcars_table 和 mtcars_table_group 之间执行左连接。\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nLEFT JOIN mtcars_table_group t2 ON t1.model_name = t2.model_name\nLIMIT 5;\n```\n\n## R\n\n```{r}\n# 对 mtcars 数据框与其自身执行左连接。\nmtcars |> left_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# 使用 pandas 执行左连接。\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='left').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"left\").head(5)\n```\n\n:::\n\n## 内连接\n\n本节演示如何执行内连接。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 使用子查询执行内连接。\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table_group LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n## R\n\n```{r}\n# 执行内连接。\nmtcars |> inner_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# 使用 pandas 执行内连接。\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='inner').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"inner\").head(5)\n```\n\n:::\n\n# 追加行\n\n## 追加时不消除重复项 (`union all`)\n\n本节介绍如何组合来自两个表的行，并保留所有重复项。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 计算原始表中的行数。\nSELECT count(*) FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 通过将 mtcars_table 追加到自身（包括重复项）来创建新表。\nCREATE TEMP TABLE double_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION ALL\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 计算新表中的行数。\nSELECT count(*) FROM double_mtcars_table;\n```\n\n### R\n\n```{r}\n# 使用 bind_rows 追加行。\nmtcars %>% bind_rows(mtcars)\n```\n\n### Python pandas\n\n```{python}\n# 连接数据框，保留所有行。\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True)\n```\n\n:::\n\n## 追加时消除重复项 (`union`)\n\n本节演示如何在组合行时删除重复条目。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 创建一个表，删除重复行。\nCREATE OR REPLACE TEMP TABLE double_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 计算新表中的行数。\nSELECT count(*) FROM double_mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- 验证不同行的计数。\nSELECT count(*) FROM (\n  SELECT DISTINCT * FROM double_mtcars_table\n);\n```\n\n### R\n\n```{r}\n# 追加行然后删除重复项。\nmtcars %>% bind_rows(mtcars) |> distinct()\n```\n\n### Python pandas\n\n```{python}\n# 连接数据框然后删除重复项。\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True).drop_duplicates()\n```\n\n:::\n\n# 删除行\n\n本节介绍如何根据条件从表中删除行。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 从表中删除特定行。\nDELETE FROM mtcars_table WHERE model_name = 'Mazda RX4';\n```\n\n```{sql}\n#| connection: con\n-- 验证删除后的行数。\nSELECT count(*) FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# 筛选掉指定的行。\nmtcars |> filter(model_name != 'Mazda RX4')\n```\n\n## Python pandas\n\n```{python}\n# 选择除指定行之外的所有行。\nmtcars_pd[mtcars_pd['model_name'] != 'Mazda RX4']\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.filter(pl.col(\"model_name\") != 'Mazda RX4')\n```\n\n:::\n\n# 更新行\n\n本节演示如何修改表中的现有数据。\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- 选择要更新的行。\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- 更新特定行的列值。\nUPDATE mtcars_table\nSET mpg = 999\nWHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- 验证更新。\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n## R\n\n```{r}\n# 在筛选的选择中更新值。\nmtcars |> filter(model_name == 'Mazda RX4 Wag') |> mutate(mpg = 999)\n```\n\n## Python pandas\n\n```{python}\n# 使用 .loc 更新特定值。\nmtcars_pd.loc[mtcars_pd['model_name'] == 'Mazda RX4 Wag', 'mpg'] = 999\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns(\n    pl.when(pl.col(\"model_name\") == 'Mazda RX4 Wag')\n    .then(999)\n    .otherwise(pl.col(\"mpg\"))\n    .alias(\"mpg\")\n)\n```\n\n:::\n\n# 删除表\n\n本节介绍如何从数据库中删除表。\n\n删除表之前：\n\n```{sql}\n#| connection: con\n-- 在删除一个表之前显示所有表。\nSHOW ALL TABLES;\n```\n\n删除表：\n\n```{sql}\n#| connection: con\n-- 如果存在，则删除指定的表。\nDROP TABLE IF EXISTS mtcars_table_group;\n```\n\n删除表之后：\n\n```{sql}\n#| connection: con\n-- 再次显示所有表以确认删除。\nSHOW ALL TABLES;\n```\n\n# PIVOT (透视)\n\n本节演示如何将数据从长格式转换为宽格式。\n\n```{sql}\n#| connection: con\n-- 为透视演示创建一个临时表。\nDROP TABLE IF EXISTS cities;\nCREATE TEMP TABLE cities (\n    country VARCHAR, name VARCHAR, year INTEGER, population INTEGER\n);\nINSERT INTO cities VALUES\n    ('NL', 'Amsterdam', 2000, 1005),\n    ('NL', 'Amsterdam', 2010, 1065),\n    ('NL', 'Amsterdam', 2020, 1158),\n    ('US', 'Seattle', 2000, 564),\n    ('US', 'Seattle', 2010, 608),\n    ('US', 'Seattle', 2020, 738),\n    ('US', 'New York City', 2000, 8015),\n    ('US', 'New York City', 2010, 8175),\n    ('US', 'New York City', 2020, 8772);\n```\n\n```{sql}\n#| connection: con\n-- 查看原始数据。\nSELECT * FROM cities;\n```\n\n## 对一列进行透视\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 对 'year' 列进行透视。\nPIVOT cities\nON year\nUSING sum(population)\nGROUP BY country;\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n## 对两列进行透视\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 对 'country' 和 'name' 进行透视。\nPIVOT cities\nON country, name\nUSING sum(population);\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index=['country', 'name'], columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index=['country', 'name'], columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n# UNPIVOT (逆透视)\n\n本节介绍如何将数据从宽格式转换为长格式。\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- 对先前透视的表进行逆透视。\nUNPIVOT\n(\n  PIVOT cities\n  ON year\n  USING sum(population)\n  GROUP BY country\n)\nON COLUMNS(* EXCLUDE (country))\nINTO\n    NAME year\n    VALUE population;\n```\n\n### Python pandas\n\n\n\n\n```{python}\ncities_pivot_pd = cities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\ncities_pivot_pd.melt(id_vars='country', value_vars=[2000, 2010, 2020], var_name='year', value_name='population')\n```\n\n### Python Polars\n\n```{python}\ncities_pl = pl.from_pandas(cities_pd)\n```\n\n\n```{python}\ncities_pivot_pl = cities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\ncities_pivot_pl.unpivot(index='country', on=['2000', '2010', '2020'], variable_name='year', value_name='population')\n```\n\n:::\n\n# EXPLAIN (解释)\n\n本节演示如何分析查询的执行计划。\n\n```{sql}\n#| eval: false\n#| connection: con\n-- 显示查询的逻辑执行计划。\nEXPLAIN\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n```{sql}\n#| eval: false\n#| connection: con\n-- 显示详细的执行计划，包括计时信息。\nEXPLAIN ANALYZE\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n```{r}\n# 断开与数据库的连接并关闭它。\ndbDisconnect(con, shutdown = TRUE)\n```\n\n# 显示精美的表格\n\n本节介绍如何创建格式精美的表格以供演示。\n\n::: panel-tabset\n\n## R\n\n```{r}\n# 使用 gt 库创建格式化的表格。\nlibrary(gt)\nmtcars |> gt()\n```\n\n## Python pandas\n\n```{python}\n# 使用 great_tables 库创建格式化的表格。\nfrom great_tables import GT\nGT(mtcars_pd)\n```\n\n## Python Polars\n\n```{python}\n# 使用 great_tables 库创建格式化的表格。\nfrom great_tables import GT\nGT(mtcars_pl)\n```\n\n\n\n\n:::\n\n# 参考资料:\n\n- [DuckDB R 客户端文档](https://duckdb.org/docs/stable/clients/r.html)\n- [DuckDB SQL 语句](https://duckdb.org/docs/stable/sql/statements)\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"show","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["foldableCodeBlcok.lua"],"css":["styles.css"],"toc":true,"number-sections":true,"output-file":"index.cn.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.25","resources":["output_data/*"],"babelquarto":{"languagecodes":[{"name":"cn","text":"中文"},{"name":"en","text":"EN"}],"mainlanguage":"en","languages":["cn"]},"title-cn":"SQL入门","description-cn":null,"author-cn":"Tony D","comments":{"giscus":{"repo":"JCfly3000/into_sql","input-position":"bottom","theme":{"light":"light","dark":"dark_dimmed"}}},"theme":{"light":"cosmo","dark":"darkly"},"grid":{"body-width":"900px","margin-width":"300px","gutter-width":"1.5rem"},"title":"SQL handbook","author":"Tony Duan","toc-location":"right","code-block-bg":true,"code-block-border-left":"#31BAE9"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}