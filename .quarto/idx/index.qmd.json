{"title":"SQL handbook","markdown":{"yaml":{"title":"SQL handbook","author":"Tony Duan","execute":{"warning":false,"error":false},"format":{"html":{"toc":true,"toc-location":"right","code-fold":"show","code-tools":true,"number-sections":true,"code-block-bg":true,"code-block-border-left":"#31BAE9"}}},"headingText":"Introduction to Data Analytics Tools","containsRefs":false,"markdown":"\n\n\nThis document provides a comprehensive guide to performing common data manipulation tasks using SQL, R, and Python. It serves as a reference for understanding how to achieve similar outcomes across these three popular data analysis tools.\n\n\nIn data analysis, we work with different tools, each with its strengths:\n\n- **SQL**: Excellent for structured query and database operations\n- **R**: Powerful statistical computing and data visualization\n- **Python**: Versatile programming with great data science libraries\n\nThis tutorial shows how to accomplish the same data manipulation tasks across all three tools, helping you choose the right approach for your needs.\n\n\n# Setup and Configuration\n\n```{r}\n#| code-fold: true\n#| output: false\nlibrary(reticulate)\npy_require(c(\"pandas\",\"Great-Tables\",\"polars\",\"pyarrow\"))\n\n# Load libraries for database interaction, data manipulation, and connections.\nlibrary(DBI)\nlibrary(tidyverse)\nlibrary(RSQLite)\nlibrary(connections)\nlibrary(duckdb)\n\n# Prepare the R dataframes.\n# Remove the existing mtcars dataset if it exists.\nrm(mtcars)\n# Create the mtcars dataframe from the base R dataset, adding the row names as a new column.\nmtcars = cbind(model_name = rownames(mtcars), mtcars) |> head(10)\n# Create the iris dataframe from the base R dataset.\niris = iris |> head(10)\n\n# Remove the database file if it already exists to start with a clean slate.\nif (file.exists(\"my-db.duckdb\")) {\n  file.remove(\"my-db.duckdb\")\n}\n# Establish a connection to the DuckDB database.\ncon <- dbConnect(duckdb(), dbdir = \"my-db.duckdb\", read_only = FALSE)\n# Write the iris and mtcars dataframes to the database as tables.\ndbWriteTable(con, \"iris_table\", iris, overwrite = TRUE)\ndbWriteTable(con, \"mtcars_table\", mtcars, overwrite = TRUE)\n\n```\n\n\n```{python}\n#| code-fold: true\n#| output: false\nimport pandas as pd\nimport polars as pl\nimport os\n\nfrom platform import python_version\n#print(python_version())\n\ncities_pd = pd.DataFrame({\n    'country': ['NL', 'NL', 'NL', 'US', 'US', 'US', 'US', 'US', 'US'],\n    'name': ['Amsterdam', 'Amsterdam', 'Amsterdam', 'Seattle', 'Seattle', 'Seattle', 'New York City', 'New York City', 'New York City'],\n    'year': [2000, 2010, 2020, 2000, 2010, 2020, 2000, 2010, 2020],\n    'population': [1005, 1065, 1158, 564, 608, 738, 8015, 8175, 8772]\n})\n\n# Make the R dataframes available in the Python environment.\nmtcars_pd = r.mtcars\niris_pd = r.iris\nmtcars_pl = pl.from_pandas(mtcars_pd)\niris_pl = pl.from_pandas(iris_pd)\ncities_pl=pl.from_pandas(cities_pd)\n```\n\n\n- There are tables `iris_table` and `mtcars_table` in the DuckDB database `my-db.duckdb`.\n- There are dataframes `iris` and `mtcars` in the R environment.\n- There are dataframes `iris` and `mtcars` in the Python environment.\n\n# Getting Started with Data Exploration\n\n## Show All Tables\n\nThis section demonstrates how to list all available tables or dataframes in each environment.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Show all tables in the connected database.\nSHOW ALL TABLES;\n```\n\n## R\n\n```{r}\n# List all dataframes in the current R environment.\ndflist <- Filter(is.data.frame, as.list(.GlobalEnv))\nnames(dflist)\n```\n\n## Python pandas\n\n```{python}\n# List all pandas dataframes in the current Python environment.\nimport pandas as pd\nalldfs = [var for var in dir() if isinstance(eval(var), pd.core.frame.DataFrame)]\nprint(alldfs)\n```\n\n## Python Polars\n\n```{python}\nimport polars as pl\n\nalldfs = [name for name, val in globals().items() if isinstance(val, pl.DataFrame)]\nprint(alldfs)\n```\n\n\n:::\n\n# Describe a Table\n\nThis section shows how to get a summary of a table's structure and statistics.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Describe the columns and data types of the mtcars_table.\nDESCRIBE mtcars_table;\n```\n\n## R\n\n```{r}\n# Provide a detailed summary of the mtcars dataframe.\nskimr::skim(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# Generate descriptive statistics for the mtcars dataframe.\nmtcars_pd.describe(include='all')\n```\n\n\n\n## Python Polars\n\n```{python}\nmtcars_pl.describe()\n```\n\n\n\n\n:::\n\n# Show Column Names\n\nThis section demonstrates how to retrieve the column names of a table.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Show information about the columns in mtcars_table.\nPRAGMA table_info(mtcars_table);\n```\n\n## R\n\n```{r}\n# Get the names of the columns in the mtcars dataframe.\nnames(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# Get a list of column names from the mtcars dataframe.\nimport pandas as pd\nlist(mtcars_pd.columns.values)\n```\n\n\n## Python Polars\n\n```{python}\n# Get a list of column names from the mtcars dataframe.\nmtcars_pl.columns\n```\n\n\n\n:::\n\n# Select\n\n## Select Top 6 and Rename\n\nThis section shows how to select a subset of columns, rename them, and limit the number of rows returned.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Select and rename columns, limiting the result to the top 6 rows.\nSELECT model_name as model, mpg, cyl FROM mtcars_table LIMIT 6;\n```\n\n## R\n\n```{r}\n# Select and rename columns from the first 6 rows of the mtcars dataframe.\nhead(mtcars, 6) |> select(model = model_name, mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# Rename a column in the mtcars dataframe.\nmtcars_pd.rename(columns={'model_name': 'model'})\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"model_name\").alias(\"model\"), pl.col(\"mpg\"), pl.col(\"cyl\")).head(6)\n```\n\n:::\n\n## Select Distinct\n\nThis section demonstrates how to retrieve unique rows based on specified columns.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Select distinct combinations of mpg and cyl.\nSELECT DISTINCT mpg, cyl FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# Get distinct rows based on mpg and cyl.\nmtcars |> distinct(mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# Select specific columns and drop duplicate rows.\ndf = mtcars_pd[[\"mpg\", \"cyl\"]]\nprint(df.drop_duplicates())\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"mpg\"), pl.col(\"cyl\")).unique()\n```\n\n:::\n\n# Check Row and Column Number\n\nThis section shows how to find the dimensions of a table.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Get the total number of rows.\nSELECT count(*) AS row_number FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Get the total number of columns.\nSELECT count(*) AS column_number FROM (DESCRIBE mtcars_table);\n```\n\n## R\n\n```{r}\n# Get the number of rows.\nnrow(mtcars)\n```\n\n```{r}\n# Get the number of columns.\nncol(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# Get the number of rows.\nmtcars_pd.shape[0]\n```\n\n```{python}\n# Get the number of columns.\nmtcars_pd.shape[1]\n```\n\n\n\n## Python Polars\n\n```{python}\n# Get the number of rows.\nmtcars_pl.shape[0]\n```\n\n```{python}\n# Get the number of columns.\nmtcars_pl.shape[1]\n```\n\n\n\n:::\n\n# Create Column\n\nThis section demonstrates how to add a new column to a table based on existing data.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Create a new column by performing a calculation on an existing column.\nSELECT *, mpg + 1 AS new_mpg FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# Add a new column to the dataframe.\nmtcars |> mutate(new_mpg = mpg + 1)\n```\n\n## Python pandas\n\n```{python}\n# Create a new column in the dataframe.\nmtcars_pd[\"new_mpg\"] = mtcars_pd[\"mpg\"] + 1\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns((pl.col(\"mpg\") + 1).alias(\"new_mpg\"))\n```\n\n:::\n\n# Filter\n\nThis section shows how to select rows that meet specific criteria.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Use the AND operator to filter rows based on multiple conditions.\nSELECT * FROM mtcars_table WHERE mpg = 21 AND cyl = 6;\n```\n\n```{sql}\n#| connection: con\n-- Use the OR operator to filter rows.\nSELECT * FROM mtcars_table WHERE mpg = 21 OR cyl = 6;\n```\n\n## R\n\n```{r}\n# Use the & operator for \"and\" filtering.\nmtcars |> filter(mpg == 21 & cyl == 6)\n```\n\n```{r}\n# Use the | operator for \"or\" filtering.\nmtcars |> filter(mpg == 21 | cyl == 6)\n```\n\n## Python pandas\n\n```{python}\n# Use the query method for \"and\" filtering.\nmtcars_pd.query('mpg == 21 and cyl == 6')\n```\n\n```{python}\n# Use the query method for \"or\" filtering.\nmtcars_pd.query('mpg == 21 or cyl == 6')\n```\n\n## Python Polars\n\n```{python}\n# \"and\" filtering with polars\nmtcars_pl.filter((pl.col(\"mpg\") == 21) & (pl.col(\"cyl\") == 6))\n```\n\n```{python}\n# \"or\" filtering with polars\nmtcars_pl.filter((pl.col(\"mpg\") == 21) | (pl.col(\"cyl\") == 6))\n```\n\n:::\n\n# Order\n\nThis section demonstrates how to sort a table based on one or more columns.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Order the results by mpg in descending order and show the top 3.\nSELECT model_name AS model, mpg, cyl FROM mtcars_table ORDER BY mpg DESC LIMIT 3;\n```\n\n## R\n\n```{r}\n# Arrange the dataframe by mpg in descending order.\nmtcars |> select(model = model_name, mpg, cyl) |> arrange(desc(mpg)) |> head(3)\n```\n\n## Python pandas\n\n```{python}\n# Sort the dataframe by mpg in descending order.\nmtcars_pd[[\"model_name\", \"mpg\", \"cyl\"]].sort_values(by='mpg', ascending=False).head(3)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(\"model_name\", \"mpg\", \"cyl\").sort(\"mpg\", descending=True).head(3)\n```\n\n:::\n\n# Group By\n\nThis section shows how to group rows and perform aggregate calculations.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Group by model_name and calculate the sum of mpg and the mean of cyl.\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1 LIMIT 5;\n```\n\n## R\n\n```{r}\n# Group by model_name and summarize the data.\nmtcars |> group_by(model_name) |> summarise(total_mpg = sum(mpg), cyl_mean = mean(cyl)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# Group by model_name and aggregate the data.\nmtcars_pd.groupby('model_name').agg({'mpg': 'sum', 'cyl': 'mean'}).head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.group_by(\"model_name\").agg([\n    pl.sum(\"mpg\").alias(\"total_mpg\"),\n    pl.mean(\"cyl\").alias(\"cyl_mean\")\n]).head(5)\n```\n\n:::\n\n# Create Table\n\n## CREATE OR REPLACE\n\nThis command creates a new table or overwrites an existing one.\n\n```{sql}\n#| connection: con\n-- Create a temporary table, replacing it if it already exists.\nCREATE OR REPLACE TEMP TABLE mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n## CREATE TABLE IF NOT EXISTS\n\nThis command creates a table only if it does not already exist.\n\n```{sql}\n#| connection: con\n-- Create a new table only if it does not already exist.\nCREATE TABLE IF NOT EXISTS new_mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n# Unique\n\n## Check Unique\n\nThis section demonstrates how to verify the uniqueness of values in a column.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Count the total number of rows and the number of distinct model names.\nSELECT count(*), count(DISTINCT model_name) FROM mtcars_table;\n```\n\n### Python pandas\n\n```{python}\n# Count the total number of rows and the number of distinct model names.\nprint(len(mtcars_pd), mtcars_pd.model_name.nunique())\n```\n\n### Python Polars\n\n```{python}\n# Count the total number of rows and the number of distinct model names.\nmtcars_pl.select(pl.count(), pl.col(\"model_name\").n_unique())\n```\n\n:::\n\n## Get Duplicate and Non-Duplicate Data\n\nThis section demonstrates how to get duplicate and non-duplicate data based on a single column.\n\n::: panel-tabset\n\n### SQL\n\n#### Show all Duplicate\n\n```{sql}\n#| connection: con\n-- Get duplicate rows based on the mpg column.\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) > 1);\n```\n\n#### Keep non-Duplicate\n\n```{sql}\n#| connection: con\n-- Get non-duplicate rows based on the mpg column.\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) = 1);\n```\n\n### R\n\n#### Show all Duplicate\n\n\n```{r}\n# Get duplicate rows based on the mpg column.\nmtcars |> filter(duplicated(mpg) | duplicated(mpg, fromLast = TRUE))\n```\n\n#### keep non Duplicate\n\n\n```{r}\n# Get non-duplicate rows based on the mpg column.\nmtcars |> filter(!duplicated(mpg) & !duplicated(mpg, fromLast = TRUE))\n```\n\n### Python pandas\n\n#### Show all Duplicate\n\n\n```{python}\n# Get duplicate rows based on the mpg column.\nmtcars_pd[mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n#### keep non Duplicate\n\n```{python}\n# Get non-duplicate rows based on the mpg column.\nmtcars_pd[~mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n\n### Python Polars\n\n```{python}\n# Get duplicate rows based on the mpg column.\nmtcars_pl.filter(pl.col(\"mpg\").is_duplicated())\n```\n\n#### keep non Duplicate\n\n```{python}\n# Get non-duplicate rows based on the mpg column.\nmtcars_pl.filter(pl.col(\"mpg\").is_unique())\n```\n\n:::\n\n\n# Join\n\n```{sql}\n#| connection: con\n-- Select all data from the newly created temporary table.\nSELECT * FROM mtcars_table_group t1;\n```\n\n## Left Join\n\nThis section shows how to perform a left join to combine data from two tables.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Perform a left join between mtcars_table and mtcars_table_group.\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nLEFT JOIN mtcars_table_group t2 ON t1.model_name = t2.model_name\nLIMIT 5;\n```\n\n## R\n\n```{r}\n# Perform a left join on the mtcars dataframe with itself.\nmtcars |> left_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# Perform a left join using pandas.\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='left').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"left\").head(5)\n```\n\n:::\n\n## Inner Join\n\nThis section demonstrates how to perform an inner join.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Perform an inner join with a subquery.\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table_group LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n## R\n\n```{r}\n# Perform an inner join.\nmtcars |> inner_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# Perform an inner join with pandas.\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='inner').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"inner\").head(5)\n```\n\n:::\n\n# Append Rows\n\n## Append Without Duplicate Elimination (`union all`)\n\nThis section shows how to combine rows from two tables, keeping all duplicates.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Count the rows in the original table.\nSELECT count(*) FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Create a new table by appending mtcars_table to itself, including duplicates.\nCREATE TEMP TABLE double_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION ALL\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Count the rows in the new table.\nSELECT count(*) FROM double_mtcars_table;\n```\n\n### R\n\n```{r}\n# Append rows using bind_rows.\nmtcars %>% bind_rows(mtcars)\n```\n\n### Python pandas\n\n```{python}\n# Concatenate dataframes, keeping all rows.\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True)\n```\n\n:::\n\n## Append With Duplicate Elimination (`union`)\n\nThis section demonstrates how to combine rows while removing duplicate entries.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Create a table, removing duplicate rows.\nCREATE OR REPLACE TEMP TABLE union_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Count the rows in the new table (should be same as original since all rows are identical).\nSELECT count(*) AS union_row_count FROM union_mtcars_table;\n```\n\n### R\n\n```{r}\n# Append rows and then remove duplicates.\nmtcars %>% bind_rows(mtcars) |> distinct()\n```\n\n### Python pandas\n\n```{python}\n# Concatenate dataframes and then drop duplicates.\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True).drop_duplicates().reset_index(drop=True)\n```\n\n:::\n\n# Delete Rows\n\nThis section shows how to remove rows from a table based on a condition.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Delete a specific row from the table.\nDELETE FROM mtcars_table WHERE model_name = 'Mazda RX4';\n```\n\n```{sql}\n#| connection: con\n-- Verify the row count after deletion.\nSELECT count(*) FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# Filter out the specified row.\nmtcars |> filter(model_name != 'Mazda RX4')\n```\n\n## Python pandas\n\n```{python}\n# Select all rows except the one specified.\nmtcars_pd[mtcars_pd['model_name'] != 'Mazda RX4']\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.filter(pl.col(\"model_name\") != 'Mazda RX4')\n```\n\n:::\n\n# Update Rows\n\nThis section demonstrates how to modify existing data in a table.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Select the row to be updated.\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- Update the value of a column for a specific row.\nUPDATE mtcars_table\nSET mpg = 999\nWHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- Verify the update.\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n## R\n\n```{r}\n# Update a value within a filtered selection.\nmtcars |> filter(model_name == 'Mazda RX4 Wag') |> mutate(mpg = 999)\n```\n\n## Python pandas\n\n```{python}\n# Update a specific value using .loc.\nmtcars_pd.loc[mtcars_pd['model_name'] == 'Mazda RX4 Wag', 'mpg'] = 999\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns(\n    pl.when(pl.col(\"model_name\") == 'Mazda RX4 Wag')\n    .then(999)\n    .otherwise(pl.col(\"mpg\"))\n    .alias(\"mpg\")\n)\n```\n\n:::\n\n# Drop Table\n\nThis section shows how to remove a table from the database.\n\nBefore dropping the table:\n\n```{sql}\n#| connection: con\n-- Show all tables before dropping one.\nSHOW ALL TABLES;\n```\n\nDropping the table:\n\n```{sql}\n#| connection: con\n-- Drop the specified table if it exists.\nDROP TABLE IF EXISTS mtcars_table_group;\n```\n\nAfter dropping the table:\n\n```{sql}\n#| connection: con\n-- Show all tables again to confirm the deletion.\nSHOW ALL TABLES;\n```\n\n# PIVOT\n\nThis section demonstrates how to transform data from a long to a wide format.\n\n```{sql}\n#| connection: con\n-- Create a temporary table for the pivot demonstration.\nDROP TABLE IF EXISTS cities;\nCREATE TEMP TABLE cities (\n    country VARCHAR, name VARCHAR, year INTEGER, population INTEGER\n);\nINSERT INTO cities VALUES\n    ('NL', 'Amsterdam', 2000, 1005),\n    ('NL', 'Amsterdam', 2010, 1065),\n    ('NL', 'Amsterdam', 2020, 1158),\n    ('US', 'Seattle', 2000, 564),\n    ('US', 'Seattle', 2010, 608),\n    ('US', 'Seattle', 2020, 738),\n    ('US', 'New York City', 2000, 8015),\n    ('US', 'New York City', 2010, 8175),\n    ('US', 'New York City', 2020, 8772);\n```\n\n```{sql}\n#| connection: con\n-- View the raw data.\nSELECT * FROM cities;\n```\n\n```{r}\n#| echo: false\ncities <- data.frame(\n  country = c('NL', 'NL', 'NL', 'US', 'US', 'US', 'US', 'US', 'US'),\n  name = c('Amsterdam', 'Amsterdam', 'Amsterdam', 'Seattle', 'Seattle', 'Seattle', 'New York City', 'New York City', 'New York City'),\n  year = c(2000, 2010, 2020, 2000, 2010, 2020, 2000, 2010, 2020),\n  population = c(1005, 1065, 1158, 564, 608, 738, 8015, 8175, 8772)\n)\n```\n\n## PIVOT on One Column\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Pivot the table on the 'year' column.\nPIVOT cities\nON year\nUSING sum(population)\nGROUP BY country;\n```\n\n### R\n\n```{r}\n# Pivot on year, summing population, grouped by country.\ncities |> \n  select(country, year, population) |> \n  pivot_wider(names_from = year, values_from = population, values_fn = sum)\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n## PIVOT on Two Columns\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Pivot on both 'country' and 'name'.\nPIVOT cities\nON country, name\nUSING sum(population);\n```\n\n### R\n\n```{r}\n# Pivot on year, summing population, keeping all other columns (country, name).\ncities |> \n  pivot_wider(names_from = year, values_from = population, values_fn = sum)\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index=['country', 'name'], columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index=['country', 'name'], columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n# UNPIVOT\n\nThis section shows how to transform data from a wide to a long format.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Unpivot the previously pivoted table.\nUNPIVOT\n(\n  PIVOT cities\n  ON year\n  USING sum(population)\n  GROUP BY country\n)\nON COLUMNS(* EXCLUDE (country))\nINTO\n    NAME year\n    VALUE population;\n```\n\n### R\n\n```{r}\n# Pivot and then unpivot.\ncities_pivot <- cities |> \n  select(country, year, population) |> \n  pivot_wider(names_from = year, values_from = population, values_fn = sum)\n\ncities_pivot |> \n  pivot_longer(cols = -country, names_to = \"year\", values_to = \"population\")\n```\n\n### Python pandas\n\n\n\n\n```{python}\ncities_pivot_pd = cities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\ncities_pivot_pd.melt(id_vars='country', value_vars=[2000, 2010, 2020], var_name='year', value_name='population')\n```\n\n### Python Polars\n\n```{python}\ncities_pivot_pl = cities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\ncities_pivot_pl.unpivot(index='country', on=['2000', '2010', '2020'], variable_name='year', value_name='population')\n```\n\n:::\n\n# EXPLAIN\n\nThis section demonstrates how to analyze the execution plan of a query.\n\n```{sql}\n#| eval: false\n#| connection: con\n-- Show the logical execution plan of a query.\nEXPLAIN\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n```{sql}\n#| eval: false\n#| connection: con\n-- Show the detailed execution plan, including timing information.\nEXPLAIN ANALYZE\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n\n\n# Display Beautiful Table\n\nThis section shows how to create nicely formatted tables for presentation.\n\n::: panel-tabset\n\n## R\n\n```{r}\n# Use the gt library to create a formatted table.\nlibrary(gt)\nmtcars |> gt()\n```\n\n## Python pandas\n\n```{python}\n# Use the great_tables library to create a formatted table.\nfrom great_tables import GT\nGT(mtcars_pd)\n```\n\n## Python Polars\n\n```{python}\n# Use the great_tables library to create a formatted table.\nfrom great_tables import GT\nGT(mtcars_pl)\n```\n\n\n\n\n:::\n\n# Window Functions\n\nThis section demonstrates how to use window functions to perform calculations across a set of table rows that are somehow related to the current row.\n\n## Rank\n\nRank rows within partitions. Here we rank cars by `mpg` (descending) within each `cyl` group.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\nSELECT model_name, cyl, mpg, \n       rank() OVER (PARTITION BY cyl ORDER BY mpg DESC) as rank \nFROM mtcars_table \nORDER BY cyl, rank\nLIMIT 10;\n```\n\n### R\n\n```{r}\nmtcars |> \n  select(model_name, cyl, mpg) |> \n  group_by(cyl) |> \n  mutate(rank = min_rank(desc(mpg))) |> \n  arrange(cyl, rank) |> \n  head(10)\n```\n\n### Python pandas\n\n```{python}\n# Rank within groups\nmtcars_pd[['model_name', 'cyl', 'mpg']].assign(\n    rank=mtcars_pd.groupby('cyl')['mpg'].rank(method='min', ascending=False)\n).sort_values(['cyl', 'rank']).head(10)\n```\n\n### Python Polars\n\n```{python}\nmtcars_pl.select(\"model_name\", \"cyl\", \"mpg\").with_columns(\n    pl.col(\"mpg\").rank(method=\"min\", descending=True).over(\"cyl\").alias(\"rank\")\n).sort(\"cyl\", \"rank\").head(10)\n```\n\n:::\n\n```{r}\n# Disconnect from the database and shut it down.\ndbDisconnect(con, shutdown = TRUE)\n```\n\n# Reference:\n\n- [DuckDB R Client Documentation](https://duckdb.org/docs/stable/clients/r.html)\n- [DuckDB SQL Statements](https://duckdb.org/docs/stable/sql/statements)\n","srcMarkdownNoYaml":"\n\n\nThis document provides a comprehensive guide to performing common data manipulation tasks using SQL, R, and Python. It serves as a reference for understanding how to achieve similar outcomes across these three popular data analysis tools.\n\n## Introduction to Data Analytics Tools\n\nIn data analysis, we work with different tools, each with its strengths:\n\n- **SQL**: Excellent for structured query and database operations\n- **R**: Powerful statistical computing and data visualization\n- **Python**: Versatile programming with great data science libraries\n\nThis tutorial shows how to accomplish the same data manipulation tasks across all three tools, helping you choose the right approach for your needs.\n\n\n# Setup and Configuration\n\n```{r}\n#| code-fold: true\n#| output: false\nlibrary(reticulate)\npy_require(c(\"pandas\",\"Great-Tables\",\"polars\",\"pyarrow\"))\n\n# Load libraries for database interaction, data manipulation, and connections.\nlibrary(DBI)\nlibrary(tidyverse)\nlibrary(RSQLite)\nlibrary(connections)\nlibrary(duckdb)\n\n# Prepare the R dataframes.\n# Remove the existing mtcars dataset if it exists.\nrm(mtcars)\n# Create the mtcars dataframe from the base R dataset, adding the row names as a new column.\nmtcars = cbind(model_name = rownames(mtcars), mtcars) |> head(10)\n# Create the iris dataframe from the base R dataset.\niris = iris |> head(10)\n\n# Remove the database file if it already exists to start with a clean slate.\nif (file.exists(\"my-db.duckdb\")) {\n  file.remove(\"my-db.duckdb\")\n}\n# Establish a connection to the DuckDB database.\ncon <- dbConnect(duckdb(), dbdir = \"my-db.duckdb\", read_only = FALSE)\n# Write the iris and mtcars dataframes to the database as tables.\ndbWriteTable(con, \"iris_table\", iris, overwrite = TRUE)\ndbWriteTable(con, \"mtcars_table\", mtcars, overwrite = TRUE)\n\n```\n\n\n```{python}\n#| code-fold: true\n#| output: false\nimport pandas as pd\nimport polars as pl\nimport os\n\nfrom platform import python_version\n#print(python_version())\n\ncities_pd = pd.DataFrame({\n    'country': ['NL', 'NL', 'NL', 'US', 'US', 'US', 'US', 'US', 'US'],\n    'name': ['Amsterdam', 'Amsterdam', 'Amsterdam', 'Seattle', 'Seattle', 'Seattle', 'New York City', 'New York City', 'New York City'],\n    'year': [2000, 2010, 2020, 2000, 2010, 2020, 2000, 2010, 2020],\n    'population': [1005, 1065, 1158, 564, 608, 738, 8015, 8175, 8772]\n})\n\n# Make the R dataframes available in the Python environment.\nmtcars_pd = r.mtcars\niris_pd = r.iris\nmtcars_pl = pl.from_pandas(mtcars_pd)\niris_pl = pl.from_pandas(iris_pd)\ncities_pl=pl.from_pandas(cities_pd)\n```\n\n\n- There are tables `iris_table` and `mtcars_table` in the DuckDB database `my-db.duckdb`.\n- There are dataframes `iris` and `mtcars` in the R environment.\n- There are dataframes `iris` and `mtcars` in the Python environment.\n\n# Getting Started with Data Exploration\n\n## Show All Tables\n\nThis section demonstrates how to list all available tables or dataframes in each environment.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Show all tables in the connected database.\nSHOW ALL TABLES;\n```\n\n## R\n\n```{r}\n# List all dataframes in the current R environment.\ndflist <- Filter(is.data.frame, as.list(.GlobalEnv))\nnames(dflist)\n```\n\n## Python pandas\n\n```{python}\n# List all pandas dataframes in the current Python environment.\nimport pandas as pd\nalldfs = [var for var in dir() if isinstance(eval(var), pd.core.frame.DataFrame)]\nprint(alldfs)\n```\n\n## Python Polars\n\n```{python}\nimport polars as pl\n\nalldfs = [name for name, val in globals().items() if isinstance(val, pl.DataFrame)]\nprint(alldfs)\n```\n\n\n:::\n\n# Describe a Table\n\nThis section shows how to get a summary of a table's structure and statistics.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Describe the columns and data types of the mtcars_table.\nDESCRIBE mtcars_table;\n```\n\n## R\n\n```{r}\n# Provide a detailed summary of the mtcars dataframe.\nskimr::skim(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# Generate descriptive statistics for the mtcars dataframe.\nmtcars_pd.describe(include='all')\n```\n\n\n\n## Python Polars\n\n```{python}\nmtcars_pl.describe()\n```\n\n\n\n\n:::\n\n# Show Column Names\n\nThis section demonstrates how to retrieve the column names of a table.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Show information about the columns in mtcars_table.\nPRAGMA table_info(mtcars_table);\n```\n\n## R\n\n```{r}\n# Get the names of the columns in the mtcars dataframe.\nnames(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# Get a list of column names from the mtcars dataframe.\nimport pandas as pd\nlist(mtcars_pd.columns.values)\n```\n\n\n## Python Polars\n\n```{python}\n# Get a list of column names from the mtcars dataframe.\nmtcars_pl.columns\n```\n\n\n\n:::\n\n# Select\n\n## Select Top 6 and Rename\n\nThis section shows how to select a subset of columns, rename them, and limit the number of rows returned.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Select and rename columns, limiting the result to the top 6 rows.\nSELECT model_name as model, mpg, cyl FROM mtcars_table LIMIT 6;\n```\n\n## R\n\n```{r}\n# Select and rename columns from the first 6 rows of the mtcars dataframe.\nhead(mtcars, 6) |> select(model = model_name, mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# Rename a column in the mtcars dataframe.\nmtcars_pd.rename(columns={'model_name': 'model'})\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"model_name\").alias(\"model\"), pl.col(\"mpg\"), pl.col(\"cyl\")).head(6)\n```\n\n:::\n\n## Select Distinct\n\nThis section demonstrates how to retrieve unique rows based on specified columns.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Select distinct combinations of mpg and cyl.\nSELECT DISTINCT mpg, cyl FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# Get distinct rows based on mpg and cyl.\nmtcars |> distinct(mpg, cyl)\n```\n\n## Python pandas\n\n```{python}\n# Select specific columns and drop duplicate rows.\ndf = mtcars_pd[[\"mpg\", \"cyl\"]]\nprint(df.drop_duplicates())\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(pl.col(\"mpg\"), pl.col(\"cyl\")).unique()\n```\n\n:::\n\n# Check Row and Column Number\n\nThis section shows how to find the dimensions of a table.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Get the total number of rows.\nSELECT count(*) AS row_number FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Get the total number of columns.\nSELECT count(*) AS column_number FROM (DESCRIBE mtcars_table);\n```\n\n## R\n\n```{r}\n# Get the number of rows.\nnrow(mtcars)\n```\n\n```{r}\n# Get the number of columns.\nncol(mtcars)\n```\n\n## Python pandas\n\n```{python}\n# Get the number of rows.\nmtcars_pd.shape[0]\n```\n\n```{python}\n# Get the number of columns.\nmtcars_pd.shape[1]\n```\n\n\n\n## Python Polars\n\n```{python}\n# Get the number of rows.\nmtcars_pl.shape[0]\n```\n\n```{python}\n# Get the number of columns.\nmtcars_pl.shape[1]\n```\n\n\n\n:::\n\n# Create Column\n\nThis section demonstrates how to add a new column to a table based on existing data.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Create a new column by performing a calculation on an existing column.\nSELECT *, mpg + 1 AS new_mpg FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# Add a new column to the dataframe.\nmtcars |> mutate(new_mpg = mpg + 1)\n```\n\n## Python pandas\n\n```{python}\n# Create a new column in the dataframe.\nmtcars_pd[\"new_mpg\"] = mtcars_pd[\"mpg\"] + 1\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns((pl.col(\"mpg\") + 1).alias(\"new_mpg\"))\n```\n\n:::\n\n# Filter\n\nThis section shows how to select rows that meet specific criteria.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Use the AND operator to filter rows based on multiple conditions.\nSELECT * FROM mtcars_table WHERE mpg = 21 AND cyl = 6;\n```\n\n```{sql}\n#| connection: con\n-- Use the OR operator to filter rows.\nSELECT * FROM mtcars_table WHERE mpg = 21 OR cyl = 6;\n```\n\n## R\n\n```{r}\n# Use the & operator for \"and\" filtering.\nmtcars |> filter(mpg == 21 & cyl == 6)\n```\n\n```{r}\n# Use the | operator for \"or\" filtering.\nmtcars |> filter(mpg == 21 | cyl == 6)\n```\n\n## Python pandas\n\n```{python}\n# Use the query method for \"and\" filtering.\nmtcars_pd.query('mpg == 21 and cyl == 6')\n```\n\n```{python}\n# Use the query method for \"or\" filtering.\nmtcars_pd.query('mpg == 21 or cyl == 6')\n```\n\n## Python Polars\n\n```{python}\n# \"and\" filtering with polars\nmtcars_pl.filter((pl.col(\"mpg\") == 21) & (pl.col(\"cyl\") == 6))\n```\n\n```{python}\n# \"or\" filtering with polars\nmtcars_pl.filter((pl.col(\"mpg\") == 21) | (pl.col(\"cyl\") == 6))\n```\n\n:::\n\n# Order\n\nThis section demonstrates how to sort a table based on one or more columns.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Order the results by mpg in descending order and show the top 3.\nSELECT model_name AS model, mpg, cyl FROM mtcars_table ORDER BY mpg DESC LIMIT 3;\n```\n\n## R\n\n```{r}\n# Arrange the dataframe by mpg in descending order.\nmtcars |> select(model = model_name, mpg, cyl) |> arrange(desc(mpg)) |> head(3)\n```\n\n## Python pandas\n\n```{python}\n# Sort the dataframe by mpg in descending order.\nmtcars_pd[[\"model_name\", \"mpg\", \"cyl\"]].sort_values(by='mpg', ascending=False).head(3)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.select(\"model_name\", \"mpg\", \"cyl\").sort(\"mpg\", descending=True).head(3)\n```\n\n:::\n\n# Group By\n\nThis section shows how to group rows and perform aggregate calculations.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Group by model_name and calculate the sum of mpg and the mean of cyl.\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1 LIMIT 5;\n```\n\n## R\n\n```{r}\n# Group by model_name and summarize the data.\nmtcars |> group_by(model_name) |> summarise(total_mpg = sum(mpg), cyl_mean = mean(cyl)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# Group by model_name and aggregate the data.\nmtcars_pd.groupby('model_name').agg({'mpg': 'sum', 'cyl': 'mean'}).head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.group_by(\"model_name\").agg([\n    pl.sum(\"mpg\").alias(\"total_mpg\"),\n    pl.mean(\"cyl\").alias(\"cyl_mean\")\n]).head(5)\n```\n\n:::\n\n# Create Table\n\n## CREATE OR REPLACE\n\nThis command creates a new table or overwrites an existing one.\n\n```{sql}\n#| connection: con\n-- Create a temporary table, replacing it if it already exists.\nCREATE OR REPLACE TEMP TABLE mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n## CREATE TABLE IF NOT EXISTS\n\nThis command creates a table only if it does not already exist.\n\n```{sql}\n#| connection: con\n-- Create a new table only if it does not already exist.\nCREATE TABLE IF NOT EXISTS new_mtcars_table_group AS\nSELECT model_name, sum(mpg) AS total_mpg, mean(cyl) AS cyl_mean FROM mtcars_table\nGROUP BY 1;\n```\n\n# Unique\n\n## Check Unique\n\nThis section demonstrates how to verify the uniqueness of values in a column.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Count the total number of rows and the number of distinct model names.\nSELECT count(*), count(DISTINCT model_name) FROM mtcars_table;\n```\n\n### Python pandas\n\n```{python}\n# Count the total number of rows and the number of distinct model names.\nprint(len(mtcars_pd), mtcars_pd.model_name.nunique())\n```\n\n### Python Polars\n\n```{python}\n# Count the total number of rows and the number of distinct model names.\nmtcars_pl.select(pl.count(), pl.col(\"model_name\").n_unique())\n```\n\n:::\n\n## Get Duplicate and Non-Duplicate Data\n\nThis section demonstrates how to get duplicate and non-duplicate data based on a single column.\n\n::: panel-tabset\n\n### SQL\n\n#### Show all Duplicate\n\n```{sql}\n#| connection: con\n-- Get duplicate rows based on the mpg column.\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) > 1);\n```\n\n#### Keep non-Duplicate\n\n```{sql}\n#| connection: con\n-- Get non-duplicate rows based on the mpg column.\nSELECT * FROM mtcars_table WHERE mpg IN (SELECT mpg FROM mtcars_table GROUP BY mpg HAVING count(*) = 1);\n```\n\n### R\n\n#### Show all Duplicate\n\n\n```{r}\n# Get duplicate rows based on the mpg column.\nmtcars |> filter(duplicated(mpg) | duplicated(mpg, fromLast = TRUE))\n```\n\n#### keep non Duplicate\n\n\n```{r}\n# Get non-duplicate rows based on the mpg column.\nmtcars |> filter(!duplicated(mpg) & !duplicated(mpg, fromLast = TRUE))\n```\n\n### Python pandas\n\n#### Show all Duplicate\n\n\n```{python}\n# Get duplicate rows based on the mpg column.\nmtcars_pd[mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n#### keep non Duplicate\n\n```{python}\n# Get non-duplicate rows based on the mpg column.\nmtcars_pd[~mtcars_pd.duplicated(subset=['mpg'], keep=False)]\n```\n\n### Python Polars\n\n```{python}\n# Get duplicate rows based on the mpg column.\nmtcars_pl.filter(pl.col(\"mpg\").is_duplicated())\n```\n\n#### keep non Duplicate\n\n```{python}\n# Get non-duplicate rows based on the mpg column.\nmtcars_pl.filter(pl.col(\"mpg\").is_unique())\n```\n\n:::\n\n\n# Join\n\n```{sql}\n#| connection: con\n-- Select all data from the newly created temporary table.\nSELECT * FROM mtcars_table_group t1;\n```\n\n## Left Join\n\nThis section shows how to perform a left join to combine data from two tables.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Perform a left join between mtcars_table and mtcars_table_group.\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nLEFT JOIN mtcars_table_group t2 ON t1.model_name = t2.model_name\nLIMIT 5;\n```\n\n## R\n\n```{r}\n# Perform a left join on the mtcars dataframe with itself.\nmtcars |> left_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# Perform a left join using pandas.\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='left').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"left\").head(5)\n```\n\n:::\n\n## Inner Join\n\nThis section demonstrates how to perform an inner join.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Perform an inner join with a subquery.\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table_group LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n## R\n\n```{r}\n# Perform an inner join.\nmtcars |> inner_join(mtcars, by = join_by(model_name == model_name)) |> head(5)\n```\n\n## Python pandas\n\n```{python}\n# Perform an inner join with pandas.\npd.merge(mtcars_pd, mtcars_pd, left_on='model_name', right_on='model_name', how='inner').head(5)\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.join(mtcars_pl, on=\"model_name\", how=\"inner\").head(5)\n```\n\n:::\n\n# Append Rows\n\n## Append Without Duplicate Elimination (`union all`)\n\nThis section shows how to combine rows from two tables, keeping all duplicates.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Count the rows in the original table.\nSELECT count(*) FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Create a new table by appending mtcars_table to itself, including duplicates.\nCREATE TEMP TABLE double_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION ALL\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Count the rows in the new table.\nSELECT count(*) FROM double_mtcars_table;\n```\n\n### R\n\n```{r}\n# Append rows using bind_rows.\nmtcars %>% bind_rows(mtcars)\n```\n\n### Python pandas\n\n```{python}\n# Concatenate dataframes, keeping all rows.\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True)\n```\n\n:::\n\n## Append With Duplicate Elimination (`union`)\n\nThis section demonstrates how to combine rows while removing duplicate entries.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Create a table, removing duplicate rows.\nCREATE OR REPLACE TEMP TABLE union_mtcars_table AS\nSELECT * FROM mtcars_table\nUNION\nSELECT * FROM mtcars_table;\n```\n\n```{sql}\n#| connection: con\n-- Count the rows in the new table (should be same as original since all rows are identical).\nSELECT count(*) AS union_row_count FROM union_mtcars_table;\n```\n\n### R\n\n```{r}\n# Append rows and then remove duplicates.\nmtcars %>% bind_rows(mtcars) |> distinct()\n```\n\n### Python pandas\n\n```{python}\n# Concatenate dataframes and then drop duplicates.\npd.concat([mtcars_pd, mtcars_pd], ignore_index=True).drop_duplicates().reset_index(drop=True)\n```\n\n:::\n\n# Delete Rows\n\nThis section shows how to remove rows from a table based on a condition.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Delete a specific row from the table.\nDELETE FROM mtcars_table WHERE model_name = 'Mazda RX4';\n```\n\n```{sql}\n#| connection: con\n-- Verify the row count after deletion.\nSELECT count(*) FROM mtcars_table;\n```\n\n## R\n\n```{r}\n# Filter out the specified row.\nmtcars |> filter(model_name != 'Mazda RX4')\n```\n\n## Python pandas\n\n```{python}\n# Select all rows except the one specified.\nmtcars_pd[mtcars_pd['model_name'] != 'Mazda RX4']\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.filter(pl.col(\"model_name\") != 'Mazda RX4')\n```\n\n:::\n\n# Update Rows\n\nThis section demonstrates how to modify existing data in a table.\n\n::: panel-tabset\n\n## SQL\n\n```{sql}\n#| connection: con\n-- Select the row to be updated.\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- Update the value of a column for a specific row.\nUPDATE mtcars_table\nSET mpg = 999\nWHERE model_name = 'Mazda RX4 Wag';\n```\n\n```{sql}\n#| connection: con\n-- Verify the update.\nSELECT model_name, mpg FROM mtcars_table WHERE model_name = 'Mazda RX4 Wag';\n```\n\n## R\n\n```{r}\n# Update a value within a filtered selection.\nmtcars |> filter(model_name == 'Mazda RX4 Wag') |> mutate(mpg = 999)\n```\n\n## Python pandas\n\n```{python}\n# Update a specific value using .loc.\nmtcars_pd.loc[mtcars_pd['model_name'] == 'Mazda RX4 Wag', 'mpg'] = 999\nmtcars_pd\n```\n\n## Python Polars\n\n```{python}\nmtcars_pl.with_columns(\n    pl.when(pl.col(\"model_name\") == 'Mazda RX4 Wag')\n    .then(999)\n    .otherwise(pl.col(\"mpg\"))\n    .alias(\"mpg\")\n)\n```\n\n:::\n\n# Drop Table\n\nThis section shows how to remove a table from the database.\n\nBefore dropping the table:\n\n```{sql}\n#| connection: con\n-- Show all tables before dropping one.\nSHOW ALL TABLES;\n```\n\nDropping the table:\n\n```{sql}\n#| connection: con\n-- Drop the specified table if it exists.\nDROP TABLE IF EXISTS mtcars_table_group;\n```\n\nAfter dropping the table:\n\n```{sql}\n#| connection: con\n-- Show all tables again to confirm the deletion.\nSHOW ALL TABLES;\n```\n\n# PIVOT\n\nThis section demonstrates how to transform data from a long to a wide format.\n\n```{sql}\n#| connection: con\n-- Create a temporary table for the pivot demonstration.\nDROP TABLE IF EXISTS cities;\nCREATE TEMP TABLE cities (\n    country VARCHAR, name VARCHAR, year INTEGER, population INTEGER\n);\nINSERT INTO cities VALUES\n    ('NL', 'Amsterdam', 2000, 1005),\n    ('NL', 'Amsterdam', 2010, 1065),\n    ('NL', 'Amsterdam', 2020, 1158),\n    ('US', 'Seattle', 2000, 564),\n    ('US', 'Seattle', 2010, 608),\n    ('US', 'Seattle', 2020, 738),\n    ('US', 'New York City', 2000, 8015),\n    ('US', 'New York City', 2010, 8175),\n    ('US', 'New York City', 2020, 8772);\n```\n\n```{sql}\n#| connection: con\n-- View the raw data.\nSELECT * FROM cities;\n```\n\n```{r}\n#| echo: false\ncities <- data.frame(\n  country = c('NL', 'NL', 'NL', 'US', 'US', 'US', 'US', 'US', 'US'),\n  name = c('Amsterdam', 'Amsterdam', 'Amsterdam', 'Seattle', 'Seattle', 'Seattle', 'New York City', 'New York City', 'New York City'),\n  year = c(2000, 2010, 2020, 2000, 2010, 2020, 2000, 2010, 2020),\n  population = c(1005, 1065, 1158, 564, 608, 738, 8015, 8175, 8772)\n)\n```\n\n## PIVOT on One Column\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Pivot the table on the 'year' column.\nPIVOT cities\nON year\nUSING sum(population)\nGROUP BY country;\n```\n\n### R\n\n```{r}\n# Pivot on year, summing population, grouped by country.\ncities |> \n  select(country, year, population) |> \n  pivot_wider(names_from = year, values_from = population, values_fn = sum)\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n## PIVOT on Two Columns\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Pivot on both 'country' and 'name'.\nPIVOT cities\nON country, name\nUSING sum(population);\n```\n\n### R\n\n```{r}\n# Pivot on year, summing population, keeping all other columns (country, name).\ncities |> \n  pivot_wider(names_from = year, values_from = population, values_fn = sum)\n```\n\n### Python pandas\n\n```{python}\ncities_pd.pivot_table(index=['country', 'name'], columns='year', values='population', aggfunc='sum').reset_index()\n```\n\n### Python Polars\n\n```{python}\ncities_pl.pivot(index=['country', 'name'], columns='year', values='population', aggregate_function='sum')\n```\n\n:::\n\n# UNPIVOT\n\nThis section shows how to transform data from a wide to a long format.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\n-- Unpivot the previously pivoted table.\nUNPIVOT\n(\n  PIVOT cities\n  ON year\n  USING sum(population)\n  GROUP BY country\n)\nON COLUMNS(* EXCLUDE (country))\nINTO\n    NAME year\n    VALUE population;\n```\n\n### R\n\n```{r}\n# Pivot and then unpivot.\ncities_pivot <- cities |> \n  select(country, year, population) |> \n  pivot_wider(names_from = year, values_from = population, values_fn = sum)\n\ncities_pivot |> \n  pivot_longer(cols = -country, names_to = \"year\", values_to = \"population\")\n```\n\n### Python pandas\n\n\n\n\n```{python}\ncities_pivot_pd = cities_pd.pivot_table(index='country', columns='year', values='population', aggfunc='sum').reset_index()\ncities_pivot_pd.melt(id_vars='country', value_vars=[2000, 2010, 2020], var_name='year', value_name='population')\n```\n\n### Python Polars\n\n```{python}\ncities_pivot_pl = cities_pl.pivot(index='country', columns='year', values='population', aggregate_function='sum')\ncities_pivot_pl.unpivot(index='country', on=['2000', '2010', '2020'], variable_name='year', value_name='population')\n```\n\n:::\n\n# EXPLAIN\n\nThis section demonstrates how to analyze the execution plan of a query.\n\n```{sql}\n#| eval: false\n#| connection: con\n-- Show the logical execution plan of a query.\nEXPLAIN\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n```{sql}\n#| eval: false\n#| connection: con\n-- Show the detailed execution plan, including timing information.\nEXPLAIN ANALYZE\nSELECT t1.model_name, t1.mpg, t1.cyl, t2.* FROM mtcars_table t1\nINNER JOIN (SELECT * FROM mtcars_table LIMIT 5) t2 ON t1.model_name = t2.model_name;\n```\n\n\n\n# Display Beautiful Table\n\nThis section shows how to create nicely formatted tables for presentation.\n\n::: panel-tabset\n\n## R\n\n```{r}\n# Use the gt library to create a formatted table.\nlibrary(gt)\nmtcars |> gt()\n```\n\n## Python pandas\n\n```{python}\n# Use the great_tables library to create a formatted table.\nfrom great_tables import GT\nGT(mtcars_pd)\n```\n\n## Python Polars\n\n```{python}\n# Use the great_tables library to create a formatted table.\nfrom great_tables import GT\nGT(mtcars_pl)\n```\n\n\n\n\n:::\n\n# Window Functions\n\nThis section demonstrates how to use window functions to perform calculations across a set of table rows that are somehow related to the current row.\n\n## Rank\n\nRank rows within partitions. Here we rank cars by `mpg` (descending) within each `cyl` group.\n\n::: panel-tabset\n\n### SQL\n\n```{sql}\n#| connection: con\nSELECT model_name, cyl, mpg, \n       rank() OVER (PARTITION BY cyl ORDER BY mpg DESC) as rank \nFROM mtcars_table \nORDER BY cyl, rank\nLIMIT 10;\n```\n\n### R\n\n```{r}\nmtcars |> \n  select(model_name, cyl, mpg) |> \n  group_by(cyl) |> \n  mutate(rank = min_rank(desc(mpg))) |> \n  arrange(cyl, rank) |> \n  head(10)\n```\n\n### Python pandas\n\n```{python}\n# Rank within groups\nmtcars_pd[['model_name', 'cyl', 'mpg']].assign(\n    rank=mtcars_pd.groupby('cyl')['mpg'].rank(method='min', ascending=False)\n).sort_values(['cyl', 'rank']).head(10)\n```\n\n### Python Polars\n\n```{python}\nmtcars_pl.select(\"model_name\", \"cyl\", \"mpg\").with_columns(\n    pl.col(\"mpg\").rank(method=\"min\", descending=True).over(\"cyl\").alias(\"rank\")\n).sort(\"cyl\", \"rank\").head(10)\n```\n\n:::\n\n```{r}\n# Disconnect from the database and shut it down.\ndbDisconnect(con, shutdown = TRUE)\n```\n\n# Reference:\n\n- [DuckDB R Client Documentation](https://duckdb.org/docs/stable/clients/r.html)\n- [DuckDB SQL Statements](https://duckdb.org/docs/stable/sql/statements)\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"show","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","filters":["foldableCodeBlcok.lua"],"css":["styles.css"],"toc":true,"number-sections":true,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.25","resources":["output_data/*"],"babelquarto":{"languagecodes":[{"name":"cn","text":""},{"name":"en","text":"EN"}],"mainlanguage":"en","languages":["cn"]},"title-cn":"SQL","description-cn":null,"author-cn":"Tony D","comments":{"giscus":{"repo":"jcwinning/into_sql","input-position":"bottom","theme":{"light":"light","dark":"dark_dimmed"}}},"theme":{"light":"cosmo","dark":"darkly"},"grid":{"body-width":"900px","margin-width":"300px","gutter-width":"1.5rem"},"title":"SQL handbook","author":"Tony Duan","toc-location":"right","code-block-bg":true,"code-block-border-left":"#31BAE9"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}